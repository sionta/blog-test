{% assign _COMMENTS = site.data.comments[page.slug] %}
{% assign _ENDPOINT = site.staticman.api
  | append: '/v2/entry/'
  | append: site.staticman.repo
  | append: '/'
  | append: site.staticman.branch
  | append: '/comments'
%}

<section class="comments">
  <h2 class="comments__title">Comments ({{ _COMMENTS | size | default: 0 }})</h2>

  {% if _COMMENTS.size > 0 %}
    <ul class="comments__entries">
      {% assign comments = _COMMENTS | sort %}
      {% for comment in comments %}
        {% assign _data = comment[1] %}
        {% assign _uuid = _data._id %}

        {% unless _data.replying_to %}
          <li class="comment comment--entry" id="{{ _uuid }}">
            <div class="comment__header">
              <h3 class="comment__author">{{ _data.name | escape }}</h3>
              <time class="comment__date" datetime="{{ _data.date | date_to_xmlschema }}">
                {{- _data.date | date: '%d %B %Y, %H:%M' -}}
              </time>
            </div>
            <div class="comment__content">
              {{ _data.message | markdownify }}
            </div>
            <div class="comment__reply">
              <button class="comment__reply-btn" type="button" onclick="showReplyForm('{{ _uuid }}')">Reply</button>
              {% assign replies = comments | where_exp: 'item', 'item[1].replying_to == _uuid' %}
              {% if replies.size > 0 %}
                <ul class="comment__reply-list" aria-labelledby="{{ _uuid }}">
                  {% for reply in replies %}
                    {% assign replyData = reply[1] %}
                    <li class="comment comment--reply" id="{{ replyData._id }}">
                      <div class="comment__header">
                        <h3 class="comment__author">{{ replyData.name | escape }}</h3>
                        <time class="comment__date" datetime="{{ replyData.date | date_to_xmlschema }}">
                          {{- replyData.date | date: '%d %B %Y, %H:%M' -}}
                        </time>
                      </div>
                      <div class="comment__content">
                        {{ replyData.message | markdownify }}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </li>
        {% endunless %}
      {% endfor %}
    </ul>
  {% else %}
    <p class="comments__empty">No comments yet. Be the first to comment!</p>
  {% endif %}

  <form class="form" method="POST" action="{{ _ENDPOINT }}" id="comment-form">
    <input type="hidden" name="options[redirect]" value="{{ page.id | absolute_url }}#comments">
    <input type="hidden" name="options[slug]" value="{{ page.slug }}">
    <input type="hidden" id="replying_to" name="fields[replying_to]" value="">

    <fieldset class="comment-form">
      <legend class="comment-form__title">Leave a comment</legend>
      <div class="comment-form__field">
        <label for="name" class="comment-form__label">Name</label>
        <input type="text" id="name" name="fields[name]" class="comment-form__input" autocomplete="name" required>
      </div>
      <div class="comment-form__field">
        <label for="email" class="comment-form__label">Email <small>(optional)</small></label>
        <input type="email" id="email" name="fields[email]" class="comment-form__input" autocomplete="email">
      </div>
      <div class="comment-form__field">
        <label for="message" class="comment-form__label">Comment</label>
        <textarea id="message" name="fields[message]" class="comment-form__textarea" rows="5" required></textarea>
      </div>
      <div class="comment-form__action">
        <button type="submit" class="comment-form__button">Send</button>
        {% comment %} <button type="reset" class="comment-form__button">Reset</button> {% endcomment %}
      </div>
    </fieldset>
  </form>
</section>

<script>
  function showReplyForm(commentId) {
    console.log('Replying to comment ID:', commentId); // Debugging
    document.getElementById('replying_to').value = commentId;
    document.getElementById('comment-form').scrollIntoView();
  }
</script>
