{% assign staticman_comments = site.data.comments[page.slug] %}
{% assign staticman_endpoint = site.staticman.api
  | append: '/v2/entry/'
  | append: site.staticman.repo
  | append: '/'
  | append: site.staticman.branch
  | append: '/comments'
%}

<section id="comments" class="comments">
  <h2 class="comments__title">Comments ({{ staticman_comments | size | default: 0 }})</h2>

  {% if staticman_comments %}
    {% assign comments = staticman_comments | sort %}
    {% for comment in comments %}
      {% assign commentData = comment[1] %}
      <div class="comment" id="comment-{{ commentData._id }}">
        <div class="comment__header">
          <h3 class="comment__author">{{ commentData.name }}</h3>
          <time class="comment__date" datetime="{{ commentData.date | date_to_xmlschema }}">
            {{ commentData.date | date: '%d %B %Y, %H:%M' }}
          </time>
        </div>
        <div class="comment__content">
          {{ commentData.message | markdownify }}
        </div>
        <div class="comment__reply">
          <button onclick="showReplyForm('{{ commentData._id }}')">Reply</button>
        </div>

        <!-- Nested comments -->
        {% for reply in comments %}
          {% assign replyData = reply[1] %}
          {% if replyData.replying_to == commentData._id %}
            <div class="comment comment--nested" id="comment-{{ replyData._id }}">
              <div class="comment__header">
                <h3 class="comment__author">{{ replyData.name }}</h3>
                <time class="comment__date" datetime="{{ replyData.date | date_to_xmlschema }}">
                  {{ replyData.date | date: '%d %B %Y, %H:%M' }}
                </time>
              </div>
              <div class="comment__content">
                {{ replyData.message | markdownify }}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  {% else %}
    <p class="comments__empty">No comments yet. Be the first to comment!</p>
  {% endif %}
</section>

<section class="comment-form">
  <h2 class="comment-form__title">Leave a comment</h2>
  <form id="comment-form" method="POST" action="{{ staticman_endpoint }}">
    <input type="hidden" name="options[redirect]" value="{{ page.id | absolute_url }}#comments">
    <input type="hidden" name="options[slug]" value="{{ page.slug }}">
    <input type="hidden" name="fields[replying_to]" id="replying_to" value="">

    <div class="comment-form__field">
      <label for="name" class="comment-form__label">Name</label>
      <input type="text" id="name" name="fields[name]" class="comment-form__input" required autocomplete="name">
    </div>

    <div class="comment-form__field">
      <label for="comment" class="comment-form__label">Comment</label>
      <textarea id="comment" name="fields[message]" class="comment-form__textarea" required></textarea>
    </div>

    <button type="submit" class="comment-form__button">Send</button>
  </form>
</section>

<script>
  function showReplyForm(commentId) {
    document.getElementById('replying_to').value = commentId;
    document.getElementById('comment-form').scrollIntoView();
  }
</script>
<style>
  .comment {
    margin-bottom: 1em;
    padding: 1em;
    border: 1px solid #ddd;
  }

  .comment--nested {
    margin-left: 2em;
    margin-top: 1em;
    border-left: 3px solid #ccc;
  }

  .comment__reply {
    margin-top: 0.5em;
  }
</style>
